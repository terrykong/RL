# Copyright (c) 2025, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Renovate

on:
  schedule:
    # Run daily at 5 PM UTC (9 AM PST / 10 AM PDT) to align with Renovate schedule
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      log_level:
        description: 'Renovate log level'
        required: false
        default: 'debug'
        type: choice
        options:
          - debug
          - info
          - warn
          - error
      dry_run:
        description: 'Dry run (no PRs created)'
        required: false
        default: false
        type: boolean

jobs:
  renovate:
    name: Renovate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
        with:
          submodules: 'recursive'

      - name: Set up Python
        uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7
        with:
          version: "0.9.1"
          enable-cache: true
          prune-cache: false

      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/sync_submodule_dependencies.py
          chmod +x .github/scripts/renovate_post_update.sh

      # Option 1: Use GitHub App token (recommended for better rate limits)
      # Requires RENOVATE_APP_ID and RENOVATE_APP_PRIVATE_KEY secrets
      # If these secrets aren't set, this step will be skipped and PAT will be used
      - name: Get GitHub App token
        id: get-app-token
        continue-on-error: true
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2
        with:
          app-id: ${{ secrets.RENOVATE_APP_ID }}
          private-key: ${{ secrets.RENOVATE_APP_PRIVATE_KEY }}

      - name: Run Renovate
        uses: renovatebot/github-action@v44.0.3
        with:
          configurationFile: .github/renovate.json
          # Use GitHub App token if available, otherwise fall back to PAT
          token: ${{ steps.get-app-token.outputs.token || secrets.RENOVATE_TOKEN }}
        env:
          LOG_LEVEL: ${{ inputs.log_level || 'info' }}
          RENOVATE_DRY_RUN: ${{ inputs.dry_run || false }}
          # Explicitly set which repository to process
          RENOVATE_REPOSITORIES: ${{ github.repository }}
          # Global-only configuration options
          RENOVATE_ONBOARDING: 'false'
          RENOVATE_REQUIRE_CONFIG: 'optional'
          RENOVATE_ALLOWED_POST_UPGRADE_COMMANDS: '["^\\.github/scripts/renovate_post_update\\.sh$"]'

